name: Generate, package, and publish release

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  generate-and-release:
    runs-on: ubuntu-latest
    env:
      OUT_DIR: generated
      VERSION_FILE: VERSION
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Lua 5.4 and prepare PATH
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.4 liblua5.4-dev luarocks build-essential make libreadline-dev tar gzip
          mkdir -p ./ci-bin
          ln -sf /usr/bin/lua5.4 ./ci-bin/lua
          ln -sf /usr/bin/luac5.4 ./ci-bin/luac
          ln -sf $(which luarocks) ./ci-bin/luarocks
          echo "$PWD/ci-bin" >> $GITHUB_PATH
          lua -v
          luarocks --version
        shell: bash

      - name: Run Makefile
        run: |
          make all
        shell: bash

      - name: Show generated tree (debug)
        run: |
          echo "generated/ directory listing:"
          ls -la generated || true
          echo "root tarballs:"
          ls -la *.tar.gz *.sha256 || true
        shell: bash

      - name: Read version file
        id: read_version
        run: |
          if [ ! -f "$VERSION_FILE" ]; then
            echo "VERSION file missing"
            exit 1
          fi
          VERSION="$(cat $VERSION_FILE | tr -d '[:space:]')"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "::set-output name=version::$VERSION"
        shell: bash

      - name: Create combined generated tarball
        run: |
          # Create a tarball of the whole generated/ directory for convenience
          tar -czf generated-${{ env.VERSION }}.tar.gz -C "${{ env.OUT_DIR }}" .
          ls -la generated-${{ env.VERSION }}.tar.gz || true
        shell: bash

      - name: Ensure package files exist
        run: |
          echo "Looking for expected package files (based on VERSION=${{ env.VERSION }})"
          ls -la lua-lib-${{ env.VERSION }}.tar.gz go-types-${{ env.VERSION }}.tar.gz emmy-headers-${{ env.VERSION }}.tar.gz || true
        shell: bash

      - name: Create / update GitHub Release and upload assets
        # ncipollo/release-action is simple: it will create or update the release and attach files
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: |
            Automated generated artifacts for version v${{ env.VERSION }}.
            This release contains generated runtime Lua modules, Emmy headers, and Go types.
          files: |
            lua-lib-${{ env.VERSION }}.tar.gz
            go-types-${{ env.VERSION }}.tar.gz
            emmy-headers-${{ env.VERSION }}.tar.gz
            generated-${{ env.VERSION }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
